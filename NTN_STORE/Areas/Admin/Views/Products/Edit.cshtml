@model NTN_STORE.Models.ViewModels.ProductFormViewModel
@{
    ViewData["Title"] = "Chỉnh sửa sản phẩm";
}

<h1 class="h3 mb-4 text-gray-800">@ViewData["Title"]</h1>
<div class="card shadow mb-4">
    <div class="card-body">
        <form asp-action="Edit" method="post" enctype="multipart/form-data">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Product.Id" />

            <div class="form-group">
                <label asp-for="Product.Name"></label>
                <input asp-for="Product.Name" class="form-control" />
                <span asp-validation-for="Product.Name" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Product.Description"></label>
                <textarea asp-for="Product.Description" class="form-control"></textarea>
                <span asp-validation-for="Product.Description" class="text-danger"></span>
            </div>

            <div class="row">
                <div class="col-md-6 form-group">
                    <label asp-for="Product.Price"></label>
                    <input asp-for="Product.Price" class="form-control" type="number" />
                </div>
                <div class="col-md-6 form-group">
                    <label asp-for="Product.OriginalPrice"></label>
                    <input asp-for="Product.OriginalPrice" class="form-control" type="number" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 form-group">
                    <label asp-for="Product.CategoryId"></label>
                    <select asp-for="Product.CategoryId" asp-items="@Model.Categories" class="form-control">
                        <option value="">-- Chọn danh mục --</option>
                    </select>
                </div>
                <div class="col-md-6 form-group">
                    <label asp-for="Product.BrandId"></label>
                    <select asp-for="Product.BrandId" asp-items="@Model.Brands" class="form-control">
                        <option value="">-- Chọn thương hiệu --</option>
                    </select>
                </div>
            </div>

            <hr class="my-4" />

            @* --- Phần Variants --- *@
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="font-weight-bold text-primary">Danh sách Size/Màu</h6>
                <button type="button" class="btn btn-sm btn-success" onclick="addVariantRow()">
                    <i class="fas fa-plus"></i> Thêm biến thể
                </button>
            </div>

            <table class="table table-bordered" id="variantsTable">
                <thead>
                    <tr>
                        <th>Size</th>
                        <th>Màu sắc</th>
                        <th>Số lượng kho</th>
                        <th style="width: 50px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Variants.Count; i++)
                    {
                        <tr>
                            @* QUAN TRỌNG: Thêm Variants.Index *@
                            <input type="hidden" name="Variants.Index" value="@i" />
                            <input type="hidden" name="Variants[@i].Id" value="@Model.Variants[i].Id" />

                            <td>
                                <input name="Variants[@i].Size" value="@Model.Variants[i].Size" class="form-control" placeholder="VD: 40" required />
                            </td>
                            <td>
                                <input name="Variants[@i].Color" value="@Model.Variants[i].Color" class="form-control" placeholder="VD: Đen" required />
                            </td>
                            <td>
                                <input name="Variants[@i].Stock" value="@Model.Variants[i].Stock" type="number" class="form-control" />
                            </td>
                            <td>
                                <button type="button" class="btn btn-danger btn-circle btn-sm" onclick="removeRow(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="form-group mt-3">
                <label>Thay đổi ảnh (Để trống nếu giữ nguyên)</label>
                <div class="custom-file">
                    <input asp-for="ImageFile" class="custom-file-input" id="customFileEdit">
                    <label class="custom-file-label" for="customFileEdit">Chọn file...</label>
                </div>
                @if (Model.Product.Images != null && Model.Product.Images.Count > 0)
                {
                    <div class="mt-2">
                        <label>Ảnh hiện tại:</label><br />
                        <img src="@Model.Product.Images.First().ImageUrl" width="100" class="img-thumbnail" />
                    </div>
                }
            </div>

            <button type="submit" class="btn btn-primary mt-3">Lưu thay đổi</button>
            <a asp-action="Index" class="btn btn-secondary mt-3">Hủy</a>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        function addVariantRow() {
            var tableBody = document.getElementById("variantsTable").getElementsByTagName('tbody')[0];
            var newRow = tableBody.insertRow();

            // Index ngẫu nhiên
            var index = new Date().getTime();

            var cell1 = newRow.insertCell(0);
            var cell2 = newRow.insertCell(1);
            var cell3 = newRow.insertCell(2);
            var cell4 = newRow.insertCell(3);

            // Input hidden cho Variants.Index và Variants[...].Id = 0 (đánh dấu là mới)
            var htmlIndex = '<input type="hidden" name="Variants.Index" value="' + index + '" />';
            var htmlId = '<input type="hidden" name="Variants[' + index + '].Id" value="0" />';

            cell1.innerHTML = htmlIndex + htmlId + '<input name="Variants[' + index + '].Size" class="form-control" required placeholder="Size" />';
            cell2.innerHTML = '<input name="Variants[' + index + '].Color" class="form-control" required placeholder="Màu" />';
            cell3.innerHTML = '<input name="Variants[' + index + '].Stock" type="number" value="100" class="form-control" />';
            cell4.innerHTML = '<button type="button" class="btn btn-danger btn-circle btn-sm" onclick="removeRow(this)"><i class="fas fa-trash"></i></button>';
        }

        function removeRow(button) {
            var row = button.closest('tr');
            row.remove();
        }

        // Update tên file khi chọn ảnh
         $(".custom-file-input").on("change", function() {
            var fileName = $(this).val().split("\\").pop();
            $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
        });
    </script>
}