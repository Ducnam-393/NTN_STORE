@model NTN_STORE.Models.Product

@{
    ViewData["Title"] = "Chi tiết sản phẩm: " + Model.Name;
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";

    // Format tiền tệ
    System.Globalization.CultureInfo cul = System.Globalization.CultureInfo.GetCultureInfo("vi-VN");
}

<style>
    /* Custom Style cho trang chi tiết */
    .stat-card {
        transition: transform 0.2s;
    }

        .stat-card:hover {
            transform: translateY(-5px);
        }

    .product-main-img {
        width: 100%;
        height: 350px;
        object-fit: contain;
        background: #fff;
        border-radius: 8px;
        border: 1px solid #eee;
    }

    .product-thumb-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 5px;
        cursor: pointer;
        border: 2px solid transparent;
    }

        .product-thumb-img:hover, .product-thumb-img.active {
            border-color: #f58220;
        }

    .variant-badge {
        font-size: 0.85rem;
        min-width: 80px;
    }
</style>

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
        Chi tiết sản phẩm <span class="text-primary small">#@Model.Id</span>
    </h1>
    <div>
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning btn-sm shadow-sm fw-bold">
            <i class="fas fa-edit fa-sm"></i> Chỉnh sửa
        </a>
        <a asp-action="Index" class="btn btn-secondary btn-sm shadow-sm">
            <i class="fas fa-arrow-left fa-sm"></i> Quay lại
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-left-success shadow h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Doanh thu sản phẩm</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.TotalRevenue.ToString("#,##0")₫</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-dollar-sign fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-left-primary shadow h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Đã bán</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.TotalSold <small>đôi</small></div>
                    </div>
                    <div class="col-auto"><i class="fas fa-shopping-bag fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-left-info shadow h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tổng Tồn Kho</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.TotalStock <small>đôi</small></div>
                    </div>
                    <div class="col-auto"><i class="fas fa-boxes fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-3">
        <div class="card border-left-warning shadow h-100 py-2 stat-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Lãi ước tính</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">@ViewBag.EstimatedProfit.ToString("#,##0")₫</div>
                    </div>
                    <div class="col-auto"><i class="fas fa-chart-line fa-2x text-gray-300"></i></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Hình ảnh</h6>
            </div>
            <div class="card-body text-center">
                @if (Model.Images != null && Model.Images.Any())
                {
                    <img id="adminMainImg" src="@Model.Images.First().ImageUrl" class="product-main-img mb-3" />
                    <div class="d-flex justify-content-center gap-2" style="overflow-x: auto;">
                        @foreach (var img in Model.Images)
                        {
                            <img src="@img.ImageUrl" class="product-thumb-img mx-1" onclick="changeAdminImage(this.src)" />
                        }
                    </div>
                }
                else
                {
                    <img src="/img/no-image.jpg" class="product-main-img" />
                    <p class="text-muted mt-2">Chưa có hình ảnh</p>
                }
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Giá & Phân loại</h6>
            </div>
            <div class="card-body">
                <table class="table table-borderless table-sm mb-0">
                    <tr>
                        <td class="text-muted">Danh mục:</td>
                        <td class="font-weight-bold">@Model.Category?.Name</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Thương hiệu:</td>
                        <td class="font-weight-bold">@Model.Brand?.Name</td>
                    </tr>
                    <tr><td colspan="2"><hr class="my-1"></td></tr>
                    <tr>
                        <td class="text-muted">Giá nhập (Vốn):</td>
                        <td class="text-danger font-weight-bold">@Model.ImportPrice.ToString("#,##0")₫</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Giá bán lẻ:</td>
                        <td class="text-success font-weight-bold" style="font-size:1.2em">@Model.Price.ToString("#,##0")₫</td>
                    </tr>
                    @if (Model.OriginalPrice.HasValue)
                    {
                        <tr>
                            <td class="text-muted">Giá gốc:</td>
                            <td class="text-secondary" style="text-decoration:line-through">@Model.OriginalPrice.Value.ToString("#,##0")₫</td>
                        </tr>
                    }
                    <tr><td colspan="2"><hr class="my-1"></td></tr>
                    <tr>
                        <td class="text-muted">Trạng thái:</td>
                        <td>
                            @if (Model.IsActive)
                            {
                                <span class="badge badge-success-soft">Đang bán</span>
                            }
                            else
                            {

                                <span class="badge badge-secondary">Đang ẩn</span>
                            }

                            @if (Model.IsFeatured)
                            {
                                <span class="badge badge-warning-soft ml-1">Nổi bật</span>
                            }
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="col-lg-8">

        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">Kho hàng & Biến thể</h6>
                <span class="badge badge-light text-dark border">Tổng tồn: @ViewBag.TotalStock</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Màu sắc</th>
                                <th class="text-center">Kích thước</th>
                                <th class="text-center">Tồn kho</th>
                                <th class="text-center">Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Variants != null && Model.Variants.Any())
                            {
                                foreach (var v in Model.Variants.OrderBy(x => x.Color).ThenBy(x => x.Size))
                                {
                                    <tr>
                                        <td>
                                            <span class="font-weight-bold">@v.Color</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge badge-secondary px-2">Size @v.Size</span>
                                        </td>
                                        <td class="text-center font-weight-bold">
                                            @v.Stock
                                        </td>
                                        <td class="text-center">
                                            @if (v.Stock == 0)
                                            {
                                                <span class="badge badge-danger variant-badge">Hết hàng</span>
                                            }
                                            else if (v.Stock <= 5)
                                            {
                                                <span class="badge badge-warning variant-badge text-dark">Sắp hết</span>
                                            }
                                            else
                                            {
                                                <span class="badge badge-success variant-badge">Sẵn sàng</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr><td colspan="4" class="text-center text-muted">Chưa có biến thể nào.</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Mô tả chi tiết</h6>
            </div>
            <div class="card-body">
                <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        @Html.Raw(Model.Description)
                    }
                    else
                    {
                        <span class="text-muted font-italic">Chưa có mô tả.</span>
                    }
                </div>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Đánh giá gần đây (@(Model.Reviews?.Count ?? 0))</h6>
            </div>
            <div class="card-body">
                @if (Model.Reviews != null && Model.Reviews.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var r in Model.Reviews.Take(3))
                        {
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>@r.User?.UserName</strong>
                                        <span class="text-warning ml-2">
                                            @for (int i = 0; i < r.Rating; i++)
                                            {
                                                <i class="fas fa-star"></i>
                                            }
                                        </span>
                                    </div>
                                    <small class="text-muted">@r.CreatedAt.ToString("dd/MM/yyyy")</small>
                                </div>
                                <p class="mb-1 small text-muted">@r.Comment</p>
                            </div>
                        }
                    </div>
                    <div class="mt-3 text-center">
                        <a href="/Admin/Reviews" class="text-primary small font-weight-bold">Xem tất cả đánh giá &rarr;</a>
                    </div>
                }
                else
                {
                    <p class="text-center text-muted my-3">Chưa có đánh giá nào.</p>
                }
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        function changeAdminImage(src) {
            document.getElementById('adminMainImg').src = src;
        }
    </script>
}