@model NTN_STORE.Models.UserAddress
@{
    ViewData["Title"] = "Cập nhật địa chỉ";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="bg-gray-100 py-5" style="min-height: 100vh;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card form-card">
                    <div class="form-header bg-warning text-white">
                        <h4 class="mb-0 fw-bold"><i class="fas fa-pen me-2"></i>Cập nhật địa chỉ</h4>
                    </div>
                    <div class="card-body p-4 p-md-5 bg-white">
                        <form asp-action="Edit">
                            <input type="hidden" asp-for="Id" />
                            <input type="hidden" asp-for="UserId" />
                            <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4"></div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Họ và tên</label>
                                    <input asp-for="FullName" class="form-control bg-light" />
                                    <span asp-validation-for="FullName" class="text-danger small"></span>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Số điện thoại</label>
                                    <input asp-for="PhoneNumber" class="form-control bg-light" />
                                    <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                                </div>

                                <div class="col-12">
                                    <div class="alert alert-info small border-0 bg-info-subtle text-info-emphasis">
                                        <i class="fas fa-info-circle me-1"></i> Địa chỉ hiện tại:
                                        <strong>@Model.Ward, @Model.District, @Model.Province</strong>.
                                        <br>Nếu không muốn thay đổi, vui lòng <strong>KHÔNG</strong> chọn lại 3 ô bên dưới.
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Tỉnh/Thành (Chọn lại)</label>
                                    <select id="province" class="form-select">
                                        <option value="">-- Giữ nguyên --</option>
                                    </select>
                                    <input type="hidden" asp-for="Province" id="provinceName" value="@Model.Province" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Quận/Huyện</label>
                                    <select id="district" class="form-select" disabled>
                                        <option value="">-- Giữ nguyên --</option>
                                    </select>
                                    <input type="hidden" asp-for="District" id="districtName" value="@Model.District" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">Phường/Xã</label>
                                    <select id="ward" class="form-select" disabled>
                                        <option value="">-- Giữ nguyên --</option>
                                    </select>
                                    <input type="hidden" asp-for="Ward" id="wardName" value="@Model.Ward" />
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-bold">Địa chỉ cụ thể</label>
                                    <input asp-for="Address" class="form-control bg-light" />
                                    <span asp-validation-for="Address" class="text-danger small"></span>
                                </div>

                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" asp-for="IsDefault" id="defaultSwitch">
                                        <label class="form-check-label" for="defaultSwitch">Đặt làm địa chỉ mặc định</label>
                                    </div>
                                </div>

                                <div class="col-12 mt-4 d-flex justify-content-end gap-2">
                                    <a asp-action="Index" class="btn btn-light px-4">Hủy</a>
                                    <button type="submit" class="btn btn-warning px-4 fw-bold text-white">Lưu thay đổi</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        // Đoạn Script này giống hệt Create, nhưng xử lý thêm logic "Giữ nguyên"
        $(document).ready(function () {
            const apiBase = "https://esgoo.net/api-tinhthanh";

            $.getJSON(apiBase + "/1/0.htm", function (data) {
                if (data.error === 0) {
                    $.each(data.data, function (key, val) {
                        $("#province").append('<option value="' + val.id + '" data-name="' + val.full_name + '">' + val.full_name + '</option>');
                    });
                }
            });

            $("#province").change(function () {
                let provinceId = $(this).val();
                if(!provinceId) return; // Nếu chọn "Giữ nguyên" thì không làm gì

                let provinceName = $(this).find("option:selected").data("name");
                $("#provinceName").val(provinceName); // Ghi đè giá trị mới

                $("#district").html('<option value="">-- Chọn Quận/Huyện --</option>').prop("disabled", true);
                $("#ward").html('<option value="">-- Chọn Phường/Xã --</option>').prop("disabled", true);

                // Xóa giá trị huyện/xã cũ trong hidden input để bắt buộc user chọn lại
                $("#districtName").val("");
                $("#wardName").val("");

                $.getJSON(apiBase + "/2/" + provinceId + ".htm", function (data) {
                    if (data.error === 0) {
                        $.each(data.data, function (key, val) {
                            $("#district").append('<option value="' + val.id + '" data-name="' + val.full_name + '">' + val.full_name + '</option>');
                        });
                        $("#district").prop("disabled", false);
                    }
                });
            });

            $("#district").change(function () {
                let districtId = $(this).val();
                let districtName = $(this).find("option:selected").data("name");
                $("#districtName").val(districtName);

                $("#ward").html('<option value="">-- Chọn Phường/Xã --</option>').prop("disabled", true);
                $("#wardName").val("");

                if (districtId) {
                    $.getJSON(apiBase + "/3/" + districtId + ".htm", function (data) {
                        if (data.error === 0) {
                            $.each(data.data, function (key, val) {
                                $("#ward").append('<option value="' + val.id + '" data-name="' + val.full_name + '">' + val.full_name + '</option>');
                            });
                            $("#ward").prop("disabled", false);
                        }
                    });
                }
            });

            $("#ward").change(function () {
                let wardName = $(this).find("option:selected").data("name");
                $("#wardName").val(wardName);
            });
        });
    </script>
}