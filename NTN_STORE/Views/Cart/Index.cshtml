@model NTN_STORE.Models.ViewModels.CartViewModel

@{
    ViewData["Title"] = "Giỏ hàng của bạn";
}

<style>
    /* Checkbox Style giống Shopee */
    .custom-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #f58220;
    }
    /* ... (Giữ nguyên các style cũ của bạn hoặc dùng style bên dưới) ... */
    .cart-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .table-cart thead th {
        border-bottom: 2px solid #eee;
        color: #555;
        text-transform: uppercase;
        font-size: 0.85rem;
        padding-bottom: 15px;
    }

    .table-cart tbody td {
        vertical-align: middle;
        padding: 20px 0;
        border-bottom: 1px solid #f5f5f5;
    }

    .cart-product-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #eee;
    }

    .cart-product-name a {
        color: #333;
        text-decoration: none;
        font-weight: 600;
        font-size: 1rem;
        transition: 0.2s;
    }

        .cart-product-name a:hover {
            color: #f58220;
        }

    .qty-control {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 5px;
        overflow: hidden;
        width: 100px;
        margin: 0 auto;
    }

    .qty-btn {
        width: 30px;
        height: 30px;
        background: #fff;
        border: none;
        color: #555;
        cursor: pointer;
    }

        .qty-btn:hover {
            background: #f58220;
            color: white;
        }

    .qty-input {
        width: 40px;
        text-align: center;
        border: none;
        font-weight: 600;
        font-size: 0.9rem;
        outline: none;
    }

    .order-summary {
        background: #fff;
        padding: 25px;
        border-radius: 10px;
        border: 1px solid #eee;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        position: sticky;
        top: 20px;
    }

    .btn-checkout {
        display: block;
        width: 100%;
        background: linear-gradient(90deg, #f58220, #ff6b6b);
        color: #fff;
        font-weight: 700;
        text-transform: uppercase;
        padding: 15px;
        border-radius: 50px;
        text-align: center;
        border: none;
        transition: 0.3s;
        margin-top: 20px;
    }

        .btn-checkout:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
</style>

<div class="cart-container py-5">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-transparent p-0">
            <li class="breadcrumb-item"><a href="/" class="text-muted text-decoration-none">Trang chủ</a></li>
            <li class="breadcrumb-item active text-dark fw-bold">Giỏ hàng</li>
        </ol>
    </nav>

    <form id="cartForm" action="/Checkout" method="get">
        <div class="row g-5">
            <div class="col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold mb-0">Giỏ hàng <span class="fs-6 text-muted fw-normal">(@Model.CartItems.Count sản phẩm)</span></h3>
                </div>

                @if (Model.CartItems.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-cart w-100">
                            <thead>
                                <tr>
                                    <th style="width: 5%" class="text-center">
                                        <input type="checkbox" id="selectAll" class="custom-checkbox" checked>
                                    </th>
                                    <th style="width: 45%">Sản phẩm</th>
                                    <th style="width: 15%" class="text-center">Đơn giá</th>
                                    <th style="width: 15%" class="text-center">Số lượng</th>
                                    <th style="width: 15%" class="text-end">Thành tiền</th>
                                    <th style="width: 5%"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.CartItems)
                                {
                                    <tr class="cart-item-row">
                                        <td class="text-center">
                                            <input type="checkbox" name="selectedIds" value="@item.Id" class="custom-checkbox item-checkbox"
                                                   data-price="@item.Product.Price"
                                                   data-qty="@item.Quantity"
                                                   checked onchange="updateTotal()">
                                        </td>

                                        <td>
                                            <div class="d-flex">
                                                <div class="me-3">
                                                    <img src="@Url.Content(item.Product.Images?.FirstOrDefault()?.ImageUrl ?? "/img/no-image.jpg")" class="cart-product-img">
                                                </div>
                                                <div>
                                                    <div class="cart-product-name">
                                                        <a asp-controller="Product" asp-action="Detail" asp-route-id="@item.ProductId">@item.Product.Name</a>
                                                    </div>
                                                    <div class="small text-muted">
                                                        @item.Variant?.Color / Size @item.Variant?.Size
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center fw-bold text-muted price-unit">@item.Product.Price.ToString("N0")₫</td>
                                        <td class="text-center">
                                            <div class="qty-control">
                                                <button type="button" class="qty-btn" onclick="changeQty(@item.Id, -1)">-</button>
                                                <input type="text" class="qty-input" id="qty-@item.Id" value="@item.Quantity" readonly>
                                                <button type="button" class="qty-btn" onclick="changeQty(@item.Id, 1)">+</button>
                                            </div>
                                        </td>
                                        <td class="text-end fw-bold text-danger price-total" id="total-@item.Id">
                                            @((item.Product.Price * item.Quantity).ToString("N0"))₫
                                        </td>
                                        <td class="text-end">
                                            <button type="button" class="btn btn-link text-danger p-0" onclick="removeItem(@item.Id)">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-5 border rounded bg-light">
                        <p class="mb-3 text-muted">Giỏ hàng trống</p>
                        <a href="/Product" class="btn btn-primary btn-sm">Mua sắm ngay</a>
                    </div>
                }
            </div>

            <div class="col-lg-4">
                <div class="order-summary">
                    <div class="mb-3 pb-3 border-bottom">
                        <h6 class="fw-bold mb-3">MÃ GIẢM GIÁ</h6>
                        @if (string.IsNullOrEmpty(Model.AppliedCoupon))
                        {
                            <div class="input-group">
                                <input type="text" id="couponInput" class="form-control text-uppercase" placeholder="Nhập mã voucher">
                                <button type="button" onclick="applyCoupon()" class="btn btn-dark">Áp dụng</button>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-success d-flex justify-content-between align-items-center p-2 mb-0 small">
                                <span>Mã <b>@Model.AppliedCoupon</b></span>
                                <a href="/Cart/RemoveCoupon" class="text-danger fw-bold text-decoration-none">Gỡ</a>
                            </div>
                        }
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Đã chọn:</span>
                        <span id="selectedCount" class="fw-bold">0 sản phẩm</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span>Tạm tính:</span>
                        <span id="subTotalDisplay" class="fw-bold">0₫</span>
                    </div>

                    <div class="d-flex justify-content-between mb-2 text-success">
                        <span>Giảm giá:</span>
                        <span id="discountDisplay">-@Model.DiscountAmount.ToString("N0")₫</span>
                    </div>

                    <div class="d-flex justify-content-between mt-3 pt-3 border-top align-items-center">
                        <span class="fw-bold h6 mb-0">TỔNG CỘNG</span>
                        <span id="finalTotalDisplay" class="text-danger fw-bold h4 mb-0">0₫</span>
                    </div>

                    <button type="submit" id="btnCheckout" class="btn-checkout">
                        MUA HÀNG
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // 1. KHỞI TẠO GIÁ TRỊ TỪ SERVER (ViewBag)
        // Dùng parseFloat để đảm bảo là số
        var currentCouponPercent = parseFloat('@(ViewBag.CouponPercent ?? 0)');
        var currentCouponAmount = parseFloat('@(ViewBag.CouponAmount ?? 0)');

        $(document).ready(function() {
            updateTotal(); // Tính tiền ngay khi load trang

            // Sự kiện chọn tất cả
            $('#selectAll').change(function() {
                $('.item-checkbox').prop('checked', $(this).prop('checked'));
                updateTotal();
            });

            // Sự kiện chọn từng món
            $('.item-checkbox').change(function() {
                // Nếu bỏ chọn 1 món -> Bỏ chọn nút All
                var allChecked = $('.item-checkbox:checked').length === $('.item-checkbox').length;
                $('#selectAll').prop('checked', allChecked);

                updateTotal(); // Tính lại tiền ngay lập tức
            });
        });

        // 2. HÀM TÍNH TIỀN (CORE LOGIC)
        function updateTotal() {
            let subTotal = 0;
            let count = 0;

            // Chỉ tính tổng tiền của các món ĐANG ĐƯỢC CHỌN (Checked)
            $('.item-checkbox:checked').each(function() {
                let price = parseFloat($(this).data('price'));
                let qty = parseInt($(this).data('qty'));
                subTotal += price * qty;
                count++;
            });

            // Tính giảm giá (Dựa trên SubTotal của các món đã chọn)
            let discount = 0;
            if (count > 0) { // Chỉ giảm giá nếu có chọn sản phẩm
                if (currentCouponPercent > 0) {
                    discount = subTotal * currentCouponPercent / 100;
                } else if (currentCouponAmount > 0) {
                    discount = currentCouponAmount;
                }

                // Không giảm quá tổng tiền
                if (discount > subTotal) discount = subTotal;
            }

            let total = subTotal - discount;

            // Hiển thị ra màn hình
            $('#selectedCount').text(count + ' sản phẩm');
            $('#subTotalDisplay').text(formatCurrency(subTotal));

            if(discount > 0) {
                $('#discountDisplay').text('-' + formatCurrency(discount));
                $('#discountDisplay').addClass('text-success');
            } else {
                $('#discountDisplay').text('0₫');
            }

            $('#finalTotalDisplay').text(formatCurrency(total));

            // Khóa nút mua nếu chưa chọn gì
            $('#btnCheckout').prop('disabled', count === 0);
            if(count === 0) {
                 $('#btnCheckout').css('opacity', '0.5').css('cursor', 'not-allowed');
            } else {
                 $('#btnCheckout').css('opacity', '1').css('cursor', 'pointer');
            }
        }

        // 3. ÁP DỤNG MÃ (DÙNG AJAX - KHÔNG LOAD LẠI TRANG)
        function applyCoupon() {
            let code = $('#couponInput').val();
            if(!code) { alert("Vui lòng nhập mã!"); return; }

            // Gọi API ApplyCouponAjax trong CartController
            $.post('/Cart/ApplyCouponAjax', { couponCode: code }, function(res) {
                if(res.success) {
                    // Cập nhật biến toàn cục JS
                    currentCouponPercent = res.percent;
                    currentCouponAmount = res.amount;

                    // Cập nhật giao diện
                    alert(res.message);

                    // Cập nhật trạng thái hiển thị mã (Tùy chỉnh thêm nếu muốn ẩn ô nhập hiện ô đã dùng)
                    // Ví dụ đơn giản: reload lại tính toán
                    updateTotal();
                } else {
                    alert(res.message);
                }
            });
        }

        // 4. GỠ MÃ GIẢM GIÁ (NẾU CÓ NÚT GỠ)
        // Bạn cần đảm bảo nút "Gỡ" gọi hàm này: onclick="removeCoupon()"
        function removeCoupon() {
             $.post('/Cart/RemoveCouponAjax', {}, function(res) {
                if(res.success) {
                    currentCouponPercent = 0;
                    currentCouponAmount = 0;
                    $('#couponInput').val('');
                    alert(res.message);
                    updateTotal();
                }
            });
        }

        // 5. CÁC HÀM KHÁC (Tăng giảm số lượng, xóa)
        function changeQty(id, change) {
            let input = $('#qty-' + id);
            let newQty = parseInt(input.val()) + change;
            if(newQty < 1) return;

            $.post('/Cart/UpdateCart', { cartItemId: id, quantity: newQty }, function() {
                input.val(newQty);
                // Cập nhật data-qty để tính toán lại đúng
                $('input[value="'+id+'"]').data('qty', newQty);

                // Cập nhật thành tiền dòng đó
                let price = parseFloat($('input[value="'+id+'"]').data('price'));
                $('#total-' + id).text(formatCurrency(price * newQty));

                updateTotal();
            });
        }

        function removeItem(id) {
            if(!confirm('Xóa sản phẩm này?')) return;
            $.post('/Cart/RemoveItem', { cartItemId: id }, function() {
                // Xóa dòng tr khỏi bảng ngay lập tức
                $('input[value="'+id+'"]').closest('tr').remove();
                updateTotal();

                // Nếu hết sản phẩm thì reload để hiện giỏ trống
                if($('.item-checkbox').length === 0) location.reload();
            });
        }

        function formatCurrency(number) {
            return number.toLocaleString('en-US') + '₫';
        }
    </script>
}