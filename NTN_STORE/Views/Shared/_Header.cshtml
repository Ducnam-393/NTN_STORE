@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager

<style>
    /* --- HEADER STYLES --- */
    .header-top {
        background-color: #f8f9fa;
        font-size: 12px;
        color: #666;
        border-bottom: 1px solid #eee;
    }

    .header-main {
        background: #fff;
        padding: 15px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 1090 !important;
    }

    /* Search Bar */
    .search-wrap {
        position: relative;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
    }

    .search-box {
        width: 100%;
        height: 42px;
        border: 2px solid #eee;
        border-radius: 50px;
        padding: 0 50px 0 20px;
        background: #f8f9fa;
        transition: all 0.3s;
        outline: none;
    }

        .search-box:focus {
            background: #fff;
            border-color: #f58220;
        }

    .search-btn-icon {
        position: absolute;
        right: 4px;
        top: 3px;
        width: 36px;
        height: 36px;
        background: #f58220;
        color: #fff;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.3s;
    }

        .search-btn-icon:hover {
            background: #d66b15;
        }

    /* Action Icons */
    .header-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 20px;
    }

    .btn-icon {
        position: relative;
        color: #333;
        font-size: 1.5rem;
        transition: 0.2s;
        display: inline-flex;
        align-items: center;
        text-decoration: none;
        cursor: pointer;
    }

        .btn-icon:hover {
            color: #f58220;
        }

    /* BADGE SỐ LƯỢNG (MÀU ĐỎ) */
    .badge-counter {
        position: absolute;
        top: -5px;
        right: -8px;
        background-color: #dc3545; /* Màu đỏ */
        color: #fff;
        font-size: 10px;
        font-weight: 700;
        min-width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* User Dropdown */
    .dropdown {
        position: relative;
    }

    .user-dropdown-menu {
        border: none;
        box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        border-radius: 8px;
        margin-top: 10px !important;
        min-width: 220px;
        padding: 0;
        overflow: hidden;
        position: absolute;
        top: 100%;
        right: 0;
        left: auto;
        z-index: 1100 !important;
        background-color: #fff;
    }

    .user-header {
        background: #f58220;
        color: white;
        padding: 15px;
    }

    .dropdown-item {
        padding: 10px 20px;
        font-size: 14px;
        color: #555;
        transition: 0.2s;
        border-bottom: 1px solid #f9f9f9;
        background-color: transparent;
    }

        .dropdown-item:hover {
            background: #fff5eb;
            color: #f58220;
            padding-left: 25px;
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
            margin-right: 10px;
        }
    /* CSS CHO SEARCH DROPDOWN */
    .search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: #fff;
        border-radius: 0 0 15px 15px;
        border: 1px solid #eee;
        border-top: none;
        display: none;
        z-index: 1000;
        overflow: hidden;
    }

    .search-item {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        text-decoration: none;
        border-bottom: 1px solid #f9f9f9;
        transition: 0.2s;
    }

        .search-item:hover {
            background-color: #f5f5f5;
        }

        .search-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            margin-right: 10px;
        }

    .search-info h6 {
        margin: 0;
        font-size: 14px;
        color: #333;
        font-weight: 600;
    }

    .search-info span {
        font-size: 13px;
        color: #d0021b;
        font-weight: bold;
    }
    /* Khung chứa dropdown */
    .header-cart-dropdown {
        display: none; /* Mặc định ẩn */
        position: absolute;
        top: 100%; /* Hiện ngay dưới icon */
        right: 0; /* Căn lề phải thẳng với icon */
        width: 350px; /* Chiều rộng giỏ hàng mini */
        background: #fff;
        z-index: 1000;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,0.1);
        margin-top: 10px; /* Cách icon ra 1 chút */
    }

        /* Mũi tên tam giác nhỏ trỏ lên (Trang trí cho đẹp giống Shopee) */
        .header-cart-dropdown::before {
            content: "";
            position: absolute;
            top: -8px;
            right: 15px;
            border-width: 0 8px 8px 8px;
            border-style: solid;
            border-color: transparent transparent #fff transparent;
            z-index: 1;
        }
        /* Viền cho mũi tên (tùy chọn) */
        .header-cart-dropdown::after {
            content: "";
            position: absolute;
            top: -10px;
            right: 15px;
            border-width: 0 8px 8px 8px;
            border-style: solid;
            border-color: transparent transparent rgba(0,0,0,0.1) transparent;
            z-index: 0;
        }

    /* Lớp cầu nối trong suốt để chuột không bị ngắt quãng khi di từ icon xuống menu */
    .cart-hover-container::after {
        content: "";
        position: absolute;
        top: 100%;
        right: 0;
        width: 100%;
        height: 15px;
        background: transparent;
    }

    /* QUAN TRỌNG: Khi di chuột vào khung chứa thì hiện dropdown */
    .cart-hover-container:hover .header-cart-dropdown {
        display: block;
        animation: fadeIn 0.2s ease;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    /* THÊM ĐOẠN NÀY: Xử lý cuộn khi danh sách quá dài */
    .cart-dropdown-content {
        max-height: 400px; /* Chiều cao tối đa, quá mức này sẽ hiện thanh cuộn */
        overflow-y: auto; /* Cho phép cuộn dọc */
        overflow-x: hidden; /* Ẩn cuộn ngang */
    }

        /* TÙY CHỌN: Làm đẹp thanh cuộn (Scrollbar) cho giống Shopee/Web hiện đại */
        /* 1. Độ rộng thanh cuộn */
        .cart-dropdown-content::-webkit-scrollbar {
            width: 6px;
        }
        /* 2. Màu nền rãnh cuộn */
        .cart-dropdown-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        /* 3. Màu thanh kéo */
        .cart-dropdown-content::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
            /* 4. Màu thanh kéo khi di chuột vào */
            .cart-dropdown-content::-webkit-scrollbar-thumb:hover {
                background: #aaa;
            }
</style>

<div class="header-top py-2 d-none d-lg-block">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-envelope me-2 text-warning"></i> hotro@ntnstore.com
                <span class="mx-2 text-muted">|</span>
                <i class="fas fa-phone-alt me-2 text-warning"></i> 0968 6868 6868
            </div>
            <div class="small text-muted">Miễn phí vận chuyển cho đơn hàng từ 1500k</div>
        </div>
    </div>
</div>

<div class="header-main">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-3 col-6">
                <a href="/" class="text-decoration-none d-flex align-items-center">
                    <span class="h2 text-uppercase fw-bold text-dark mb-0">NTN</span>
                    <span class="h2 text-uppercase fw-bold text-warning mb-0">Store</span>
                </a>
            </div>

            <div class="col-lg-6 d-none d-lg-block">
                <div class="search-wrap">
                    <form asp-controller="Product" asp-action="Index" method="get">
                        <input type="text" name="search" id="searchInput" class="form-control search-input"
                               placeholder="Bạn tìm gì hôm nay? (Giày Nike, Adidas...)"
                               value="@ViewContext.HttpContext.Request.Query["search"]" autocomplete="off">
                        <button type="submit" class="search-btn-icon"><i class="fas fa-search"></i></button>
                    </form>
                    <div id="searchResults" class="search-dropdown shadow-sm"></div>
                </div>
            </div>

            <div class="col-lg-3 col-6 header-actions">

                <div class="dropdown">
                    <a href="#" class="btn-icon" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="far fa-user"></i>
                    </a>
                    <ul class="dropdown-menu user-dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        @if (SignInManager.IsSignedIn(User))
                        {
                            <li>
                                <div class="user-header">
                                    <div class="fw-bold">Xin chào,</div>
                                    <div class="small text-truncate" style="max-width: 180px;">@User.Identity?.Name</div>
                                </div>
                            </li>

                            @if (User.IsInRole("Admin"))
                            {
                                <li>
                                    <a class="dropdown-item fw-bold text-primary" asp-area="Admin" asp-controller="Home" asp-action="Index">
                                        <i class="fas fa-tachometer-alt"></i> Trang Quản trị (Admin)
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider m-0"></li>
                            }
                            <li><a class="dropdown-item" asp-area="Identity" asp-page="/Account/Manage/Index"><i class="fas fa-user-cog"></i> Tài khoản của tôi</a></li>             
                            <li>
                                <form asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })" method="post" class="m-0">
                                    <button type="submit" class="dropdown-item text-danger"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
                                </form>
                            </li>
                        }
                        else
                        {
                            <li><div class="user-header fw-bold">Tài khoản</div></li>
                            <li><a class="dropdown-item" asp-area="Identity" asp-page="/Account/Login"><i class="fas fa-sign-in-alt"></i> Đăng nhập</a></li>
                            <li><a class="dropdown-item" asp-area="Identity" asp-page="/Account/Register"><i class="fas fa-user-plus"></i> Đăng ký</a></li>
                        }
                    </ul>
                </div>

                <a asp-area="" asp-controller="Wishlist" asp-action="Index" class="btn-icon position-relative" title="Yêu thích">
                    <i class="far fa-heart"></i>
                    @await Component.InvokeAsync("WishlistBadge")
                </a>

                <div class="cart-hover-container">

                    <a asp-area="" asp-controller="Cart" asp-action="Index" class="btn-icon text-dark relative-link" title="Giỏ hàng">
                        <i class="fas fa-shopping-bag fa-lg"></i>
                        @await Component.InvokeAsync("CartBadge")
                    </a>

                    <div class="header-cart-dropdown shadow-sm" id="headerMiniCart">
                        <div class="cart-dropdown-content">
                            <div class="text-center py-3">
                                <div class="spinner-border text-warning spinner-sm" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    // JS XỬ LÝ TÌM KIẾM
    // Lưu ý: Đảm bảo jQuery đã được load (thường ở _Layout)
    $(document).ready(function() {
        let timeout = null;

        $('#searchInput').on('keyup', function() {
            clearTimeout(timeout);
            var term = $(this).val();
            var resultBox = $('#searchResults');

            if(term.length < 2) {
                resultBox.hide();
                return;
            }

            // Delay 300ms để tránh gọi API quá nhiều khi đang gõ
            timeout = setTimeout(function() {
                $.get('/Product/SearchJson?term=' + term, function(data) {
                    resultBox.empty();
                    if(data.length > 0) {
                        $.each(data, function(index, item) {
                            var html = `
                                <a href="/Product/Detail/${item.id}" class="search-item">
                                    <img src="${item.image}" alt="${item.name}">
                                    <div class="search-info">
                                        <h6 class="text-truncate">${item.name}</h6>
                                        <span>${item.price.toLocaleString('vi-VN')}₫</span>
                                    </div>
                                </a>`;
                            resultBox.append(html);
                        });
                        resultBox.slideDown(200);
                    } else {
                        resultBox.hide();
                    }
                });
            }, 300);
        });

        // Ẩn khi click ra ngoài
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.search-wrap').length) {
                $('#searchResults').hide();
            }
        });
    });
    
</script>